<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AI 应用中的一些前端技术 | 钟灵毓秀</title><meta name=keywords content><meta name=description content='
以下内容 95% 由 AI 生成
SSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石
在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的"打字机"效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。'><meta name=author content="zhongling"><link rel=canonical href=https://tomorrowthief.github.io/posts/ai-tec-web/><link crossorigin=anonymous href=/assets/css/stylesheet.min.63a977388f59c67668ee225d0f9dd2605b70ac8d24a582d553a3580d80b50f33.css integrity="sha256-Y6l3OI9ZxnZo7iJdD53SYFtwrI0kpYLVU6NYDYC1DzM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.555af97124d54bb1457985dd081b8f5616a48103aafeb30ac89fde835d65aa6c.js integrity="sha256-VVr5cSTVS7FFeYXdCBuPVhakgQOq/rMKyJ/eg11lqmw=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://tomorrowthief.github.io/posts/ai-tec-web/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AI 应用中的一些前端技术"><meta property="og:description" content='
以下内容 95% 由 AI 生成
SSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石
在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的"打字机"效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。'><meta property="og:type" content="article"><meta property="og:url" content="https://tomorrowthief.github.io/posts/ai-tec-web/"><meta property="og:image" content="https://tomorrowthief.github.io/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-28T16:25:41+08:00"><meta property="article:modified_time" content="2025-09-28T16:25:41+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tomorrowthief.github.io/cover.png"><meta name=twitter:title content="AI 应用中的一些前端技术"><meta name=twitter:description content='
以下内容 95% 由 AI 生成
SSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石
在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的"打字机"效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tomorrowthief.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AI 应用中的一些前端技术","item":"https://tomorrowthief.github.io/posts/ai-tec-web/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AI 应用中的一些前端技术","name":"AI 应用中的一些前端技术","description":" 以下内容 95% 由 AI 生成\nSSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石\n在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的\u0026quot;打字机\u0026quot;效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。\n","keywords":[],"articleBody":" 以下内容 95% 由 AI 生成\nSSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石\n在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的\"打字机\"效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。\nSSE 协议 为什么选择 SSE？ WebSocket 功能强大，但对于单向的服务器推送场景，SSE 提供了更简洁的解决方案。它基于 HTTP 协议，无需额外的握手过程，天然支持断线重连，完美契合 AI 对话的流式输出需求。\nSSE 的核心优势在于其简单性：\n基于标准 HTTP，无需特殊协议升级 自动重连机制，网络容错性强 文本协议，调试友好 浏览器原生支持，无需额外库 协议解析：一行一世界 SSE 协议看似简单，实则暗藏玄机。每个事件由多行文本组成，以空行分隔：\nid: 123 event: message data: {\"type\": \"answer\", \"content\": \"这是\"} data: {\"type\": \"answer\", \"content\": \"AI的回答\"} id: 124 event: message data: {\"type\": \"answer\", \"content\": \"继续输出\"} 关键字段解析：\ndata: 事件数据，可有多行，自动拼接 id: 事件 ID，用于断线重连时的位置恢复 event: 事件类型，默认为 “message” retry: 重连间隔，服务器可动态调整 实战：手写 SSE 客户端 现代浏览器的 EventSource API 虽易用，但灵活性不足。手动实现 SSE 客户端能让我们完全掌控数据流：\nclass SSEClient { constructor(url, options = {}) { this.url = url; this.headers = options.headers || {}; this.onMessage = options.onMessage || (() =\u003e {}); this.onError = options.onError || (() =\u003e {}); this.onConnect = options.onConnect || (() =\u003e {}); this.buffer = ''; this.controller = null; } async connect() { try { this.controller = new AbortController(); const response = await fetch(this.url, { headers: { 'Accept': 'text/event-stream', 'Cache-Control': 'no-cache', ...this.headers }, signal: this.controller.signal }); if (!response.ok) { throw new Error(`HTTP ${response.status}`); } this.onConnect(); const reader = response.body.getReader(); const decoder = new TextDecoder(); while (true) { const { done, value } = await reader.read(); if (done) { this.onError(new Error('Stream ended')); break; } this.buffer += decoder.decode(value, { stream: true }); this.processBuffer(); } } catch (error) { if (error.name !== 'AbortError') { this.onError(error); } } } processBuffer() { const lines = this.buffer.split('\\n'); this.buffer = lines.pop() || ''; let event = null; for (const line of lines) { if (line === '') { if (event \u0026\u0026 event.data) { this.onMessage(event); } event = null; continue; } if (!event) { event = { id: null, event: 'message', data: '', retry: null }; } const colonIndex = line.indexOf(':'); if (colonIndex === -1) continue; const field = line.slice(0, colonIndex); const value = line.slice(colonIndex + 1).replace(/^\\s/, ''); switch (field) { case 'data': event.data += (event.data ? '\\n' : '') + value; break; case 'id': event.id = value; break; case 'event': event.event = value; break; case 'retry': event.retry = parseInt(value, 10); break; } } } disconnect() { if (this.controller) { this.controller.abort(); } } } // 使用示例 const client = new SSEClient('/api/chat', { onConnect: () =\u003e console.log('已连接'), onMessage: (event) =\u003e { const data = JSON.parse(event.data); console.log('收到消息:', data); }, onError: (error) =\u003e console.error('连接错误:', error) }); client.connect(); 业务协议设计：在 SSE 之上 实际应用中，我们通常在 SSE 协议之上封装业务协议。以 AI 对话为例：\n// 业务协议格式 { \"type\": \"thought\", // 思考过程 \"content\": \"让我分析一下...\", \"node_id\": \"node_123\" } { \"type\": \"tool_call\", // 工具调用 \"tool\": \"search\", \"parameters\": { \"query\": \"...\" } } { \"type\": \"answer\", // 最终回答 \"content\": \"根据分析...\", \"finished\": true } { \"type\": \"message_end\", // 消息结束 \"metadata\": { \"total_tokens\": 150, \"model\": \"gpt-4\" } } 这种分层设计让 SSE 专注于传输，业务逻辑保持清晰。\n错误处理与重连机制 class RobustSSEClient extends SSEClient { constructor(url, options = {}) { super(url, options); this.maxRetries = options.maxRetries || 3; this.retryDelay = options.retryDelay || 1000; this.retryCount = 0; this.lastEventId = null; } async connect() { try { // 添加最后的事件 ID if (this.lastEventId) { this.headers['Last-Event-ID'] = this.lastEventId; } await super.connect(); this.retryCount = 0; // 重置重试计数 } catch (error) { this.handleConnectionError(error); } } handleConnectionError(error) { if (this.retryCount \u003c this.maxRetries) { this.retryCount++; console.log(`连接失败，${this.retryDelay}ms 后重试 (第 ${this.retryCount} 次)`); setTimeout(() =\u003e { this.connect(); }, this.retryDelay); // 指数退避 this.retryDelay = Math.min(this.retryDelay * 2, 30000); } else { this.onError(new Error('最大重试次数已达上限')); } } onMessage(event) { // 保存最后的事件 ID if (event.id) { this.lastEventId = event.id; } super.onMessage(event); } } markdown 渲染 解析原理：DSL 的三部曲 Markdown 渲染本质上是领域特定语言（DSL）的处理过程，遵循经典的编译原理：\n词法分析：将字符流转换为记号（Token）流 语法分析：将记号组合成语法结构 代码生成：将语法结构转换为目标格式（HTML） 流式渲染：打字机效果的核心 在 AI 对话系统中，我们需要实现增量渲染来支持流式输出：\n/** * 流式Markdown渲染器 * 支持增量解析，适用于SSE流式数据 */ class StreamingMarkdownRenderer { constructor() { this.patterns = { header: /^(#{1,6})\\s+(.+)$/gm, bold: /\\*\\*(.*?)\\*\\*/g, italic: /\\*(.*?)\\*/g, inlineCode: /`([^`]+)`/g, codeBlock: /```([\\s\\S]*?)```/g, blockquote: /^\u003e\\s*(.+)$/gm, unorderedList: /^[-*+]\\s+(.+)$/gm, orderedList: /^\\d+\\.\\s+(.+)$/gm, link: /\\[([^\\]]+)\\]\\(([^)]+)\\)/g }; this.buffer = ''; this.completedHtml = ''; } processChunk(chunk) { this.buffer += chunk; // 尝试解析完整的 Markdown 块 const blocks = this.extractCompleteBlocks(this.buffer); if (blocks.complete.length \u003e 0) { const html = this.render(blocks.complete.join('\\n\\n')); this.completedHtml += html; this.buffer = blocks.incomplete; return { html: this.completedHtml, delta: html, isComplete: false }; } return { html: this.completedHtml, delta: '', isComplete: false }; } extractCompleteBlocks(text) { const paragraphs = text.split('\\n\\n'); const complete = []; let incomplete = ''; for (let i = 0; i \u003c paragraphs.length; i++) { const para = paragraphs[i].trim(); if (this.isCompleteElement(para)) { complete.push(para); } else if (i === paragraphs.length - 1) { incomplete = para; } else { complete.push(para); } } return { complete, incomplete }; } isCompleteElement(para) { if (/^#{1,6}\\s+/.test(para)) return true; if (para.includes('```')) { const matches = para.match(/```/g); return matches \u0026\u0026 matches.length % 2 === 0; } if (/^[-*+\\d+]\\s+/.test(para)) return true; if (/^\u003e\\s+/.test(para)) return true; return para.length \u003e 0 \u0026\u0026 para.length \u003c 200; } render(markdown) { let html = markdown; // 处理顺序很重要 html = this.renderCodeBlocks(html); html = this.renderHeaders(html); html = this.renderBlockquotes(html); html = this.renderLists(html); html = this.renderInlineElements(html); html = this.renderParagraphs(html); return html; } renderCodeBlocks(text) { return text.replace(this.patterns.codeBlock, (match, code) =\u003e { const cleanCode = code.replace(/^\\n|\\n$/g, ''); return `${this.escapeHtml(cleanCode)}`; }); } renderHeaders(text) { return text.replace(this.patterns.header, (match, hashes, content) =\u003e { const level = hashes.length; return `","wordCount":"4182","inLanguage":"zh","datePublished":"2025-09-28T16:25:41+08:00","dateModified":"2025-09-28T16:25:41+08:00","author":{"@type":"Person","name":"zhongling"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tomorrowthief.github.io/posts/ai-tec-web/"},"publisher":{"@type":"Organization","name":"钟灵毓秀","logo":{"@type":"ImageObject","url":"https://tomorrowthief.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tomorrowthief.github.io/ accesskey=h title="钟灵毓秀 (Alt + H)">钟灵毓秀</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://tomorrowthief.github.io/archives title=归档><span>归档</span></a></li><li><a href=https://tomorrowthief.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://tomorrowthief.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://tomorrowthief.github.io/search/ title=查找><span>查找</span></a></li><li><a href=https://tomorrowthief.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>AI 应用中的一些前端技术</h1><div class=post-meta><span title='2025-09-28 16:25:41 +0800 +0800'>九月 28, 2025</span>&nbsp;·&nbsp;9 分钟&nbsp;·&nbsp;zhongling</div></header><main class=post-main id=post-main><div class=post-content><blockquote><p>以下内容 95% 由 AI 生成</p></blockquote><p>SSE 协议与 Markdown 渲染：构建现代 AI 对话系统的基石</p><p>在 ChatGPT、Claude 等 AI 对话系统中，那种逐字逐句的"打字机"效果背后，是两项看似普通却至关重要的技术：Server-Sent Events (SSE) 协议和 Markdown 渲染引擎。本文将深入剖析这两项技术的原理、实现细节，以及在 AI 时代的创新应用。</p><h2 id=sse-协议>SSE 协议<a hidden class=anchor aria-hidden=true href=#sse-协议>#</a></h2><h3 id=为什么选择-sse>为什么选择 SSE？<a hidden class=anchor aria-hidden=true href=#为什么选择-sse>#</a></h3><p>WebSocket 功能强大，但对于单向的服务器推送场景，SSE 提供了更简洁的解决方案。它基于 HTTP 协议，无需额外的握手过程，天然支持断线重连，完美契合 AI 对话的流式输出需求。</p><p>SSE 的核心优势在于其<strong>简单性</strong>：</p><ul><li>基于标准 HTTP，无需特殊协议升级</li><li>自动重连机制，网络容错性强</li><li>文本协议，调试友好</li><li>浏览器原生支持，无需额外库</li></ul><h3 id=协议解析一行一世界>协议解析：一行一世界<a hidden class=anchor aria-hidden=true href=#协议解析一行一世界>#</a></h3><p>SSE 协议看似简单，实则暗藏玄机。每个事件由多行文本组成，以空行分隔：</p><pre tabindex=0><code>id: 123
event: message
data: {&#34;type&#34;: &#34;answer&#34;, &#34;content&#34;: &#34;这是&#34;}
data: {&#34;type&#34;: &#34;answer&#34;, &#34;content&#34;: &#34;AI的回答&#34;}

id: 124
event: message
data: {&#34;type&#34;: &#34;answer&#34;, &#34;content&#34;: &#34;继续输出&#34;}
</code></pre><p>关键字段解析：</p><ul><li><code>data</code>: 事件数据，可有多行，自动拼接</li><li><code>id</code>: 事件 ID，用于断线重连时的位置恢复</li><li><code>event</code>: 事件类型，默认为 &ldquo;message&rdquo;</li><li><code>retry</code>: 重连间隔，服务器可动态调整</li></ul><h3 id=实战手写-sse-客户端>实战：手写 SSE 客户端<a hidden class=anchor aria-hidden=true href=#实战手写-sse-客户端>#</a></h3><p>现代浏览器的 EventSource API 虽易用，但灵活性不足。手动实现 SSE 客户端能让我们完全掌控数据流：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>SSEClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>url</span> <span class=o>=</span> <span class=nx>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>headers</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>headers</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>onMessage</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>onMessage</span> <span class=o>||</span> <span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{});</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>onError</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>onError</span> <span class=o>||</span> <span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{});</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>onConnect</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>onConnect</span> <span class=o>||</span> <span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>controller</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>connect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>controller</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AbortController</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;Accept&#39;</span><span class=o>:</span> <span class=s1>&#39;text/event-stream&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;Cache-Control&#39;</span><span class=o>:</span> <span class=s1>&#39;no-cache&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>...</span><span class=k>this</span><span class=p>.</span><span class=nx>headers</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>signal</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>controller</span><span class=p>.</span><span class=nx>signal</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`HTTP </span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>onConnect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>reader</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>getReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>decoder</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TextDecoder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>done</span><span class=p>,</span> <span class=nx>value</span> <span class=p>}</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>reader</span><span class=p>.</span><span class=nx>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>onError</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Stream ended&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>+=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=p>{</span> <span class=nx>stream</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>processBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>name</span> <span class=o>!==</span> <span class=s1>&#39;AbortError&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>onError</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>processBuffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>lines</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>=</span> <span class=nx>lines</span><span class=p>.</span><span class=nx>pop</span><span class=p>()</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>event</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>line</span> <span class=k>of</span> <span class=nx>lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>line</span> <span class=o>===</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>event</span> <span class=o>&amp;&amp;</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>onMessage</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>id</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>event</span><span class=o>:</span> <span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=nx>data</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>retry</span><span class=o>:</span> <span class=kc>null</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>colonIndex</span> <span class=o>=</span> <span class=nx>line</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>colonIndex</span> <span class=o>===</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>field</span> <span class=o>=</span> <span class=nx>line</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>colonIndex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>line</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>colonIndex</span> <span class=o>+</span> <span class=mi>1</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/^\s/</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>switch</span> <span class=p>(</span><span class=nx>field</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;data&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=o>+=</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=o>?</span> <span class=s1>&#39;\n&#39;</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;id&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>event</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;event&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>event</span><span class=p>.</span><span class=nx>event</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;retry&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>event</span><span class=p>.</span><span class=nx>retry</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>disconnect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>controller</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>controller</span><span class=p>.</span><span class=nx>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用示例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SSEClient</span><span class=p>(</span><span class=s1>&#39;/api/chat&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>onConnect</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;已连接&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>onMessage</span><span class=o>:</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;收到消息:&#39;</span><span class=p>,</span> <span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>onError</span><span class=o>:</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;连接错误:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span></code></pre></div><h3 id=业务协议设计在-sse-之上>业务协议设计：在 SSE 之上<a hidden class=anchor aria-hidden=true href=#业务协议设计在-sse-之上>#</a></h3><p>实际应用中，我们通常在 SSE 协议之上封装业务协议。以 AI 对话为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 业务协议格式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span><span class=o>:</span> <span class=s2>&#34;thought&#34;</span><span class=p>,</span>        <span class=c1>// 思考过程
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;content&#34;</span><span class=o>:</span> <span class=s2>&#34;让我分析一下...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;node_id&#34;</span><span class=o>:</span> <span class=s2>&#34;node_123&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span><span class=o>:</span> <span class=s2>&#34;tool_call&#34;</span><span class=p>,</span>      <span class=c1>// 工具调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;tool&#34;</span><span class=o>:</span> <span class=s2>&#34;search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;parameters&#34;</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;query&#34;</span><span class=o>:</span> <span class=s2>&#34;...&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span><span class=o>:</span> <span class=s2>&#34;answer&#34;</span><span class=p>,</span>         <span class=c1>// 最终回答
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;content&#34;</span><span class=o>:</span> <span class=s2>&#34;根据分析...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;finished&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span><span class=o>:</span> <span class=s2>&#34;message_end&#34;</span><span class=p>,</span>    <span class=c1>// 消息结束
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;total_tokens&#34;</span><span class=o>:</span> <span class=mi>150</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;model&#34;</span><span class=o>:</span> <span class=s2>&#34;gpt-4&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这种分层设计让 SSE 专注于传输，业务逻辑保持清晰。</p><h3 id=错误处理与重连机制>错误处理与重连机制<a hidden class=anchor aria-hidden=true href=#错误处理与重连机制>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>RobustSSEClient</span> <span class=kr>extends</span> <span class=nx>SSEClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>maxRetries</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>maxRetries</span> <span class=o>||</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>retryDelay</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>retryDelay</span> <span class=o>||</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>retryCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>lastEventId</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>connect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 添加最后的事件 ID
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>lastEventId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;Last-Event-ID&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lastEventId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=kr>super</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>retryCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 重置重试计数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>handleConnectionError</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleConnectionError</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>retryCount</span> <span class=o>&lt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>maxRetries</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>retryCount</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`连接失败，</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>retryDelay</span><span class=si>}</span><span class=sb>ms 后重试 (第 </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>retryCount</span><span class=si>}</span><span class=sb> 次)`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=k>this</span><span class=p>.</span><span class=nx>retryDelay</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 指数退避
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>retryDelay</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>retryDelay</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>30000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>onError</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;最大重试次数已达上限&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>onMessage</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 保存最后的事件 ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>lastEventId</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>.</span><span class=nx>onMessage</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=markdown-渲染>markdown 渲染<a hidden class=anchor aria-hidden=true href=#markdown-渲染>#</a></h2><h3 id=解析原理dsl-的三部曲>解析原理：DSL 的三部曲<a hidden class=anchor aria-hidden=true href=#解析原理dsl-的三部曲>#</a></h3><p>Markdown 渲染本质上是领域特定语言（DSL）的处理过程，遵循经典的编译原理：</p><ol><li><strong>词法分析</strong>：将字符流转换为记号（Token）流</li><li><strong>语法分析</strong>：将记号组合成语法结构</li><li><strong>代码生成</strong>：将语法结构转换为目标格式（HTML）</li></ol><h3 id=流式渲染打字机效果的核心>流式渲染：打字机效果的核心<a hidden class=anchor aria-hidden=true href=#流式渲染打字机效果的核心>#</a></h3><p>在 AI 对话系统中，我们需要实现增量渲染来支持流式输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 流式Markdown渲染器
</span></span></span><span class=line><span class=cl><span class=cm> * 支持增量解析，适用于SSE流式数据
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StreamingMarkdownRenderer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>patterns</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>header</span><span class=o>:</span> <span class=sr>/^(#{1,6})\s+(.+)$/gm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>bold</span><span class=o>:</span> <span class=sr>/\*\*(.*?)\*\*/g</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>italic</span><span class=o>:</span> <span class=sr>/\*(.*?)\*/g</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>inlineCode</span><span class=o>:</span> <span class=sr>/`([^`]+)`/g</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>codeBlock</span><span class=o>:</span> <span class=sr>/```([\s\S]*?)```/g</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>blockquote</span><span class=o>:</span> <span class=sr>/^&gt;\s*(.+)$/gm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>unorderedList</span><span class=o>:</span> <span class=sr>/^[-*+]\s+(.+)$/gm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>orderedList</span><span class=o>:</span> <span class=sr>/^\d+\.\s+(.+)$/gm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=o>:</span> <span class=sr>/\[([^\]]+)\]\(([^)]+)\)/g</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>completedHtml</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>processChunk</span><span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>+=</span> <span class=nx>chunk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 尝试解析完整的 Markdown 块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>blocks</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>extractCompleteBlocks</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>blocks</span><span class=p>.</span><span class=nx>complete</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=nx>blocks</span><span class=p>.</span><span class=nx>complete</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n\n&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>completedHtml</span> <span class=o>+=</span> <span class=nx>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>=</span> <span class=nx>blocks</span><span class=p>.</span><span class=nx>incomplete</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>html</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>completedHtml</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>delta</span><span class=o>:</span> <span class=nx>html</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isComplete</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>html</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>completedHtml</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>delta</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>isComplete</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>extractCompleteBlocks</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>paragraphs</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;\n\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>complete</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>incomplete</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>paragraphs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>para</span> <span class=o>=</span> <span class=nx>paragraphs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>trim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isCompleteElement</span><span class=p>(</span><span class=nx>para</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>complete</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>para</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>===</span> <span class=nx>paragraphs</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>incomplete</span> <span class=o>=</span> <span class=nx>para</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>complete</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>para</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>complete</span><span class=p>,</span> <span class=nx>incomplete</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>isCompleteElement</span><span class=p>(</span><span class=nx>para</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=sr>/^#{1,6}\s+/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>para</span><span class=p>))</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>para</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;```&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>matches</span> <span class=o>=</span> <span class=nx>para</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=sr>/```/g</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>matches</span> <span class=o>&amp;&amp;</span> <span class=nx>matches</span><span class=p>.</span><span class=nx>length</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>===</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=sr>/^[-*+\d+]\s+/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>para</span><span class=p>))</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=sr>/^&gt;\s+/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>para</span><span class=p>))</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>para</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>para</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>200</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>(</span><span class=nx>markdown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>markdown</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理顺序很重要
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderCodeBlocks</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderHeaders</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderBlockquotes</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderLists</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderInlineElements</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>renderParagraphs</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderCodeBlocks</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>codeBlock</span><span class=p>,</span> <span class=p>(</span><span class=nx>match</span><span class=p>,</span> <span class=nx>code</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>cleanCode</span> <span class=o>=</span> <span class=nx>code</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/^\n|\n$/g</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=sb>`&lt;pre&gt;&lt;code&gt;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>escapeHtml</span><span class=p>(</span><span class=nx>cleanCode</span><span class=p>)</span><span class=si>}</span><span class=sb>&lt;/code&gt;&lt;/pre&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderHeaders</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>header</span><span class=p>,</span> <span class=p>(</span><span class=nx>match</span><span class=p>,</span> <span class=nx>hashes</span><span class=p>,</span> <span class=nx>content</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>level</span> <span class=o>=</span> <span class=nx>hashes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=sb>`&lt;h</span><span class=si>${</span><span class=nx>level</span><span class=si>}</span><span class=sb>&gt;</span><span class=si>${</span><span class=nx>content</span><span class=p>.</span><span class=nx>trim</span><span class=p>()</span><span class=si>}</span><span class=sb>&lt;/h</span><span class=si>${</span><span class=nx>level</span><span class=si>}</span><span class=sb>&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderBlockquotes</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>blockquote</span><span class=p>,</span> <span class=s1>&#39;&lt;blockquote&gt;$1&lt;/blockquote&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderLists</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=nx>html</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>unorderedList</span><span class=p>,</span> <span class=s1>&#39;&lt;li&gt;$1&lt;/li&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>html</span> <span class=o>=</span> <span class=nx>html</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>orderedList</span><span class=p>,</span> <span class=s1>&#39;&lt;li&gt;$1&lt;/li&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>wrapListItems</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>wrapListItems</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/(&lt;li&gt;.*&lt;\/li&gt;)(?![\s\S]*&lt;\/ul&gt;)/g</span><span class=p>,</span> <span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>match</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;&lt;ul&gt;&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=sb>`&lt;ul&gt;</span><span class=si>${</span><span class=nx>match</span><span class=si>}</span><span class=sb>&lt;/ul&gt;`</span> <span class=o>:</span> <span class=nx>match</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/(&lt;li&gt;.*&lt;\/li&gt;)(?![\s\S]*&lt;\/ol&gt;)/g</span><span class=p>,</span> <span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>match</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;&lt;ol&gt;&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=sb>`&lt;ol&gt;</span><span class=si>${</span><span class=nx>match</span><span class=si>}</span><span class=sb>&lt;/ol&gt;`</span> <span class=o>:</span> <span class=nx>match</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderInlineElements</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>bold</span><span class=p>,</span> <span class=s1>&#39;&lt;strong&gt;$1&lt;/strong&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>italic</span><span class=p>,</span> <span class=s1>&#39;&lt;em&gt;$1&lt;/em&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>inlineCode</span><span class=p>,</span> <span class=s1>&#39;&lt;code&gt;$1&lt;/code&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>patterns</span><span class=p>.</span><span class=nx>link</span><span class=p>,</span> <span class=s1>&#39;&lt;a href=&#34;$2&#34;&gt;$1&lt;/a&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>renderParagraphs</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>lines</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>result</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>inParagraph</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>line</span> <span class=k>of</span> <span class=nx>lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>line</span> <span class=o>=</span> <span class=nx>line</span><span class=p>.</span><span class=nx>trim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>line</span> <span class=o>||</span> <span class=k>this</span><span class=p>.</span><span class=nx>isHtmlElement</span><span class=p>(</span><span class=nx>line</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>inParagraph</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>result</span> <span class=o>+=</span> <span class=s1>&#39;&lt;/p&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>inParagraph</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>result</span> <span class=o>+=</span> <span class=nx>line</span> <span class=o>+</span> <span class=s1>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>inParagraph</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>result</span> <span class=o>+=</span> <span class=s1>&#39;&lt;p&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>inParagraph</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>result</span> <span class=o>+=</span> <span class=nx>line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>inParagraph</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>result</span> <span class=o>+=</span> <span class=s1>&#39;&lt;/p&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>isHtmlElement</span><span class=p>(</span><span class=nx>line</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sr>/^(&lt;h[1-6]&gt;|&lt;pre&gt;|&lt;blockquote&gt;|&lt;ul&gt;|&lt;ol&gt;|&lt;li&gt;)/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>escapeHtml</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>div</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=性能优化节流渲染>性能优化：节流渲染<a hidden class=anchor aria-hidden=true href=#性能优化节流渲染>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ThrottledRenderer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=nx>fps</span> <span class=o>=</span> <span class=mi>30</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>renderer</span> <span class=o>=</span> <span class=nx>renderer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>frameInterval</span> <span class=o>=</span> <span class=mi>1000</span> <span class=o>/</span> <span class=nx>fps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>lastFrame</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>scheduleRender</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processRenders</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>processRenders</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>now</span> <span class=o>-</span> <span class=k>this</span><span class=p>.</span><span class=nx>lastFrame</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=nx>frameInterval</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>combined</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>renderer</span><span class=p>.</span><span class=nx>processChunk</span><span class=p>(</span><span class=nx>combined</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>lastFrame</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pendingRenders</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>requestAnimationFrame</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>processRenders</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=markdown-it-组件>markdown-it 组件<a hidden class=anchor aria-hidden=true href=#markdown-it-组件>#</a></h3><p>markdown-it 是目前最流行的 JavaScript Markdown 解析器之一，它基于 CommonMark 规范实现，具有高性能和良好的扩展性。</p><h4 id=核心原理>核心原理<a hidden class=anchor aria-hidden=true href=#核心原理>#</a></h4><p>markdown-it 采用<strong>两阶段解析</strong>架构：</p><ol><li><strong>词法分析阶段</strong>：将输入文本分解为 Token 流</li><li><strong>渲染阶段</strong>：将 Token 转换为 HTML</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>md</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;markdown-it&#39;</span><span class=p>)();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tokens</span> <span class=o>=</span> <span class=nx>md</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=s1>&#39;# Hello\n\n**World**&#39;</span><span class=p>);</span> <span class=c1>// 生成 Token 流
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>md</span><span class=p>.</span><span class=nx>renderer</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=nx>tokens</span><span class=p>);</span>          <span class=c1>// 渲染为 HTML
</span></span></span></code></pre></div><h4 id=核心特性>核心特性<a hidden class=anchor aria-hidden=true href=#核心特性>#</a></h4><ul><li><strong>CommonMark 兼容</strong>：严格遵循 CommonMark 规范</li><li><strong>高性能</strong>：基于状态机的快速解析</li><li><strong>插件系统</strong>：丰富的插件生态</li><li><strong>安全</strong>：默认进行 HTML 转义</li><li><strong>可定制</strong>：规则链可自定义</li></ul><h4 id=插件生态>插件生态<a hidden class=anchor aria-hidden=true href=#插件生态>#</a></h4><p>markdown-it 的强大之处在于其插件系统，支持各种扩展：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 表格支持
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>markdownItTable</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;markdown-it-table&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>md</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>markdownItTable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 数学公式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>math</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;markdown-it-math&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>md</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>math</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 流程图
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>mermaid</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;markdown-it-mermaid&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>md</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>mermaid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 代码高亮
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>hljs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;highlight.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>md</span><span class=p>.</span><span class=nx>configure</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>highlight</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>str</span><span class=p>,</span> <span class=nx>lang</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>lang</span> <span class=o>&amp;&amp;</span> <span class=nx>hljs</span><span class=p>.</span><span class=nx>getLanguage</span><span class=p>(</span><span class=nx>lang</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>hljs</span><span class=p>.</span><span class=nx>highlight</span><span class=p>(</span><span class=nx>lang</span><span class=p>,</span> <span class=nx>str</span><span class=p>).</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h4 id=与简单实现的对比>与简单实现的对比<a hidden class=anchor aria-hidden=true href=#与简单实现的对比>#</a></h4><table><thead><tr><th>特性</th><th>简单正则实现</th><th>markdown-it</th></tr></thead><tbody><tr><td><strong>解析方式</strong></td><td>正则表达式链式替换</td><td>状态机 + Token 系统</td></tr><tr><td><strong>性能</strong></td><td>中等</td><td>高优化</td></tr><tr><td><strong>标准兼容</strong></td><td>基础语法</td><td>完整 CommonMark</td></tr><tr><td><strong>扩展性</strong></td><td>需修改核心</td><td>插件系统</td></tr><tr><td><strong>错误处理</strong></td><td>简单</td><td>完善的错误恢复</td></tr></tbody></table><h4 id=实际应用场景>实际应用场景<a hidden class=anchor aria-hidden=true href=#实际应用场景>#</a></h4><p>markdown-it 广泛应用于：</p><ul><li><strong>静态网站生成器</strong>：VuePress、VitePress</li><li><strong>富文本编辑器</strong>：Typora、VS Code 插件</li><li><strong>文档系统</strong>：Docusaurus、GitBook</li><li><strong>AI 对话系统</strong>：ChatGPT、Claude 等对话界面的 Markdown 渲染</li></ul><h4 id=性能优化>性能优化<a hidden class=anchor aria-hidden=true href=#性能优化>#</a></h4><p>markdown-it 通过以下方式实现高性能：</p><ul><li><strong>状态机解析</strong>：避免重复正则匹配</li><li><strong>Token 缓存</strong>：可缓存解析结果</li><li><strong>流式处理</strong>：支持大文档的流式解析</li><li><strong>内存优化</strong>：高效的内存管理</li></ul><p>在 AI 对话系统中，markdown-it 特别适合处理 SSE 流式数据，因为它可以：</p><ul><li>增量解析部分 Markdown 内容</li><li>保持解析状态，处理不完整的 Markdown 块</li><li>快速渲染打字机效果</li><li>支持代码块的语法高亮</li></ul><h3 id=remark--unified-组件>remark & unified 组件<a hidden class=anchor aria-hidden=true href=#remark--unified-组件>#</a></h3><p>remark 和 unified 是一个更加强大和灵活的 Markdown 处理生态系统，基于 AST（抽象语法树）的转换方式，提供了前所未有的可定制性和扩展能力。</p><h4 id=核心架构>核心架构<a hidden class=anchor aria-hidden=true href=#核心架构>#</a></h4><p>unified 是一个通用的内容处理框架，remark 是其生态中专用于 Markdown 的处理器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>unified</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;unified&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>remarkParse</span> <span class=nx>from</span> <span class=s1>&#39;remark-parse&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>remarkRehype</span> <span class=nx>from</span> <span class=s1>&#39;remark-rehype&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>rehypeStringify</span> <span class=nx>from</span> <span class=s1>&#39;rehype-stringify&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>processor</span> <span class=o>=</span> <span class=nx>unified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkParse</span><span class=p>)</span>      <span class=c1>// Markdown → AST
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkRehype</span><span class=p>)</span>     <span class=c1>// AST → HTML AST
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeStringify</span><span class=p>)</span>  <span class=c1>// HTML AST → HTML
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>processor</span><span class=p>.</span><span class=nx>processSync</span><span class=p>(</span><span class=s1>&#39;# Hello **World**&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=工作流程>工作流程<a hidden class=anchor aria-hidden=true href=#工作流程>#</a></h4><pre tabindex=0><code>Markdown 文本 → remark-parse → Markdown AST → remark-rehype → HTML AST → rehype-stringify → HTML
</code></pre><h4 id=核心优势>核心优势<a hidden class=anchor aria-hidden=true href=#核心优势>#</a></h4><ul><li><strong>AST 基础</strong>：基于抽象语法树，提供精确的语法结构</li><li><strong>插件生态</strong>：丰富的插件生态系统</li><li><strong>多格式支持</strong>：不仅限于 HTML，可输出 React、Vue、JSX 等</li><li><strong>类型安全</strong>：完整的 TypeScript 支持</li><li><strong>可组合性</strong>：插件可以组合和链式调用</li></ul><h4 id=插件生态-1>插件生态<a hidden class=anchor aria-hidden=true href=#插件生态-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 代码高亮
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>remarkPrism</span> <span class=nx>from</span> <span class=s1>&#39;remark-prism&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 数学公式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>remarkMath</span> <span class=nx>from</span> <span class=s1>&#39;remark-math&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>rehypeKatex</span> <span class=nx>from</span> <span class=s1>&#39;rehype-katex&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 目录生成
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>remarkToc</span> <span class=nx>from</span> <span class=s1>&#39;remark-toc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 链接检查
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>remarkValidateLinks</span> <span class=nx>from</span> <span class=s1>&#39;remark-validate-links&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>processor</span> <span class=o>=</span> <span class=nx>unified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkParse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkPrism</span><span class=p>)</span>           <span class=c1>// 代码语法高亮
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkMath</span><span class=p>)</span>           <span class=c1>// 数学公式支持
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkToc</span><span class=p>)</span>            <span class=c1>// 自动生成目录
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkValidateLinks</span><span class=p>)</span>  <span class=c1>// 验证链接有效性
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkRehype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeKatex</span><span class=p>)</span>          <span class=c1>// 渲染数学公式
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeStringify</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=高级用法自定义转换>高级用法：自定义转换<a hidden class=anchor aria-hidden=true href=#高级用法自定义转换>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 自定义插件修改 AST
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>myCustomPlugin</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=nx>tree</span><span class=p>,</span> <span class=nx>file</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历和修改 AST
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>visit</span><span class=p>(</span><span class=nx>tree</span><span class=p>,</span> <span class=s1>&#39;link&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>node</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 为所有链接添加 target=&#34;_blank&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>node</span><span class=p>.</span><span class=nx>data</span> <span class=o>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>      <span class=nx>node</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hProperties</span> <span class=o>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hProperties</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>      <span class=nx>node</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hProperties</span><span class=p>.</span><span class=nx>target</span> <span class=o>=</span> <span class=s1>&#39;_blank&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>processor</span> <span class=o>=</span> <span class=nx>unified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkParse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>myCustomPlugin</span><span class=p>)</span>  <span class=c1>// 使用自定义插件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkRehype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeStringify</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=输出格式多样性>输出格式多样性<a hidden class=anchor aria-hidden=true href=#输出格式多样性>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 输出 React 组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rehypeReact</span> <span class=nx>from</span> <span class=s1>&#39;rehype-react&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出 Vue 组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rehypeVue</span> <span class=nx>from</span> <span class=s1>&#39;rehype-vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出 JSX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rehypeJsx</span> <span class=nx>from</span> <span class=s1>&#39;rehype-jsx&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>reactProcessor</span> <span class=o>=</span> <span class=nx>unified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkParse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkRehype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeReact</span><span class=p>,</span> <span class=p>{</span> <span class=nx>createElement</span><span class=o>:</span> <span class=nx>React</span><span class=p>.</span><span class=nx>createElement</span> <span class=p>})</span>
</span></span></code></pre></div><h4 id=与-markdown-it-的对比>与 markdown-it 的对比<a hidden class=anchor aria-hidden=true href=#与-markdown-it-的对比>#</a></h4><table><thead><tr><th>特性</th><th>markdown-it</th><th>remark & unified</th></tr></thead><tbody><tr><td><strong>核心机制</strong></td><td>Token 流</td><td>AST 抽象语法树</td></tr><tr><td><strong>性能</strong></td><td>极高</td><td>中等（AST 开销）</td></tr><tr><td><strong>扩展性</strong></td><td>插件系统</td><td>插件 + AST 转换</td></tr><tr><td><strong>学习曲线</strong></td><td>简单</td><td>较陡峭</td></tr><tr><td><strong>输出格式</strong></td><td>HTML</td><td>HTML、React、Vue、JSX 等</td></tr><tr><td><strong>类型支持</strong></td><td>部分</td><td>完整的 TypeScript</td></tr><tr><td><strong>适用场景</strong></td><td>快速渲染</td><td>复杂转换和处理</td></tr></tbody></table><h4 id=性能考量>性能考量<a hidden class=anchor aria-hidden=true href=#性能考量>#</a></h4><p>remark & unified 的性能特点：</p><ul><li><strong>AST 开销</strong>：构建和操作抽象语法树有额外性能成本</li><li><strong>内存占用</strong>：AST 结构比 Token 流占用更多内存</li><li><strong>处理时间</strong>：多步骤转换增加处理时间</li><li><strong>优化策略</strong>：<ul><li>缓存处理结果</li><li>按需加载插件</li><li>使用流式处理大文件</li></ul></li></ul><h4 id=实际应用场景-1>实际应用场景<a hidden class=anchor aria-hidden=true href=#实际应用场景-1>#</a></h4><p>remark & unified 适用于：</p><ul><li><strong>静态网站生成器</strong>：Next.js、Gatsby 等框架的 Markdown 处理</li><li><strong>文档系统</strong>：需要复杂转换和自定义处理的文档系统</li><li><strong>内容管理系统</strong>：多格式输出需求的内容平台</li><li><strong>构建工具</strong>：webpack、Vite 等构建工具的 Markdown 处理</li><li><strong>IDE 插件</strong>：VS Code、WebStorm 等编辑器的 Markdown 支持</li></ul><h4 id=在-sse-场景下的应用>在 SSE 场景下的应用<a hidden class=anchor aria-hidden=true href=#在-sse-场景下的应用>#</a></h4><p>在 AI 对话系统的 SSE 流式传输中，remark & unified 可以：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 增量解析 SSE 数据流
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>processSSEStream</span><span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>partialMarkdown</span> <span class=o>=</span> <span class=nx>accumulateChunk</span><span class=p>(</span><span class=nx>chunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 remark 处理部分 Markdown
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>processor</span> <span class=o>=</span> <span class=nx>unified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkParse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>remarkRehype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>rehypeStringify</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>processor</span><span class=p>.</span><span class=nx>processSync</span><span class=p>(</span><span class=nx>partialMarkdown</span><span class=p>).</span><span class=nx>toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUI</span><span class=p>(</span><span class=nx>html</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理不完整的 Markdown 块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;等待更多数据...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>虽然性能不如 markdown-it，但 remark & unified 提供了无与伦比的灵活性和精确控制能力，特别适合需要复杂 Markdown 处理的场景。</p><h2 id=实战案例构建-ai-对话界面>实战案例：构建 AI 对话界面<a hidden class=anchor aria-hidden=true href=#实战案例构建-ai-对话界面>#</a></h2><h3 id=完整架构>完整架构<a hidden class=anchor aria-hidden=true href=#完整架构>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>AIChatInterface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>sseClient</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>RobustSSEClient</span><span class=p>(</span><span class=s1>&#39;/api/chat&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>markdownRenderer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>StreamingMarkdownRenderer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>messageContainer</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;messages&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>currentMessage</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>throttledRenderer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ThrottledRenderer</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>markdownRenderer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>sendMessage</span><span class=p>(</span><span class=nx>userInput</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加用户消息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>addUserMessage</span><span class=p>(</span><span class=nx>userInput</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 AI 消息容器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>currentMessage</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>createAIMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 连接 SSE
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>sseClient</span><span class=p>.</span><span class=nx>onMessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>handleStreamData</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;解析失败:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>sseClient</span><span class=p>.</span><span class=nx>onComplete</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>finalizeMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>sseClient</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleStreamData</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;answer&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>appendContent</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;thought&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>showThinking</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;tool_call&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>showToolCall</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;error&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>showError</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>appendContent</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用节流渲染器避免频繁更新
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>throttledRenderer</span><span class=p>.</span><span class=nx>scheduleRender</span><span class=p>(</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取最新渲染结果
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>markdownRenderer</span><span class=p>.</span><span class=nx>processChunk</span><span class=p>(</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>delta</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 打字机效果
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>typeWriterEffect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>delta</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新完整内容
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>currentMessage</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>scrollToBottom</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>typeWriterEffect</span><span class=p>(</span><span class=nx>html</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>temp</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>temp</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>textNodes</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>extractTextNodes</span><span class=p>(</span><span class=nx>temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>typeNext</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>index</span> <span class=o>&lt;</span> <span class=nx>textNodes</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>node</span> <span class=o>=</span> <span class=nx>textNodes</span><span class=p>[</span><span class=nx>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>text</span> <span class=o>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>textContent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>animateText</span><span class=p>(</span><span class=nx>node</span><span class=p>,</span> <span class=nx>text</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>index</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>typeNext</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>typeNext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>extractTextNodes</span><span class=p>(</span><span class=nx>element</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>nodes</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>walker</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createTreeWalker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>NodeFilter</span><span class=p>.</span><span class=nx>SHOW_TEXT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>node</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>node</span> <span class=o>=</span> <span class=nx>walker</span><span class=p>.</span><span class=nx>nextNode</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>nodes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>nodes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>animateText</span><span class=p>(</span><span class=nx>node</span><span class=p>,</span> <span class=nx>text</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>node</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>typeChar</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>index</span> <span class=o>&lt;</span> <span class=nx>text</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>node</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>+=</span> <span class=nx>text</span><span class=p>[</span><span class=nx>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nx>index</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>typeChar</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>typeChar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addUserMessage</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>messageEl</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>messageEl</span><span class=p>.</span><span class=nx>className</span> <span class=o>=</span> <span class=s1>&#39;message user-message&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>messageEl</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=sb>`&lt;div class=&#34;content&#34;&gt;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>escapeHtml</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span><span class=si>}</span><span class=sb>&lt;/div&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>messageContainer</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>messageEl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>createAIMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>messageEl</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>messageEl</span><span class=p>.</span><span class=nx>className</span> <span class=o>=</span> <span class=s1>&#39;message ai-message&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>messageEl</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s1>&#39;&lt;div class=&#34;content&#34;&gt;&lt;/div&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>messageContainer</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>messageEl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>messageEl</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;.content&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>scrollToBottom</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>messageContainer</span><span class=p>.</span><span class=nx>scrollTop</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>messageContainer</span><span class=p>.</span><span class=nx>scrollHeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>escapeHtml</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>div</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=总结与展望>总结与展望<a hidden class=anchor aria-hidden=true href=#总结与展望>#</a></h2><p>SSE 与 Markdown 的组合看似简单，实则蕴含着深刻的技术洞察。SSE 以其轻量级和可靠性，完美解决了 AI 对话的实时性问题；Markdown 则以其简洁性和表现力，成为 AI 内容生成的理想载体。</p><p>这种技术组合的核心价值在于：<strong>在简单与强大之间找到完美平衡</strong>。不需要复杂的 WebSocket 握手，也不需要重量级的富文本编辑器，就能实现专业级的 AI 对话体验。</p><p>未来发展趋势：</p><ul><li><strong>WebTransport</strong>：新一代 Web 传输协议，可能替代 SSE</li><li><strong>增量渲染</strong>：更智能的部分内容更新策略</li><li><strong>多模态支持</strong>：文本、图像、代码的混合渲染</li><li><strong>AI 辅助渲染</strong>：根据内容类型智能选择渲染方式</li></ul><p>掌握这两项技术，不仅能构建出色的 AI 对话界面，更能深入理解现代 Web 应用的精髓：<strong>用最小的复杂度解决最实际的问题</strong>。</p></div><div class=post-toc id=post-toc><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#sse-%e5%8d%8f%e8%ae%ae aria-label="SSE 协议">SSE 协议</a><ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9-sse aria-label="为什么选择 SSE？">为什么选择 SSE？</a></li><li><a href=#%e5%8d%8f%e8%ae%ae%e8%a7%a3%e6%9e%90%e4%b8%80%e8%a1%8c%e4%b8%80%e4%b8%96%e7%95%8c aria-label=协议解析：一行一世界>协议解析：一行一世界</a></li><li><a href=#%e5%ae%9e%e6%88%98%e6%89%8b%e5%86%99-sse-%e5%ae%a2%e6%88%b7%e7%ab%af aria-label="实战：手写 SSE 客户端">实战：手写 SSE 客户端</a></li><li><a href=#%e4%b8%9a%e5%8a%a1%e5%8d%8f%e8%ae%ae%e8%ae%be%e8%ae%a1%e5%9c%a8-sse-%e4%b9%8b%e4%b8%8a aria-label="业务协议设计：在 SSE 之上">业务协议设计：在 SSE 之上</a></li><li><a href=#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e4%b8%8e%e9%87%8d%e8%bf%9e%e6%9c%ba%e5%88%b6 aria-label=错误处理与重连机制>错误处理与重连机制</a></li></ul></li><li><a href=#markdown-%e6%b8%b2%e6%9f%93 aria-label="markdown 渲染">markdown 渲染</a><ul><li><a href=#%e8%a7%a3%e6%9e%90%e5%8e%9f%e7%90%86dsl-%e7%9a%84%e4%b8%89%e9%83%a8%e6%9b%b2 aria-label="解析原理：DSL 的三部曲">解析原理：DSL 的三部曲</a></li><li><a href=#%e6%b5%81%e5%bc%8f%e6%b8%b2%e6%9f%93%e6%89%93%e5%ad%97%e6%9c%ba%e6%95%88%e6%9e%9c%e7%9a%84%e6%a0%b8%e5%bf%83 aria-label=流式渲染：打字机效果的核心>流式渲染：打字机效果的核心</a></li><li><a href=#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e8%8a%82%e6%b5%81%e6%b8%b2%e6%9f%93 aria-label=性能优化：节流渲染>性能优化：节流渲染</a></li><li><a href=#markdown-it-%e7%bb%84%e4%bb%b6 aria-label="markdown-it 组件">markdown-it 组件</a><ul><li><a href=#%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86 aria-label=核心原理>核心原理</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7 aria-label=核心特性>核心特性</a></li><li><a href=#%e6%8f%92%e4%bb%b6%e7%94%9f%e6%80%81 aria-label=插件生态>插件生态</a></li><li><a href=#%e4%b8%8e%e7%ae%80%e5%8d%95%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%af%b9%e6%af%94 aria-label=与简单实现的对比>与简单实现的对比</a></li><li><a href=#%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label=实际应用场景>实际应用场景</a></li><li><a href=#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label=性能优化>性能优化</a></li></ul></li><li><a href=#remark--unified-%e7%bb%84%e4%bb%b6 aria-label="remark & unified 组件">remark & unified 组件</a><ul><li><a href=#%e6%a0%b8%e5%bf%83%e6%9e%b6%e6%9e%84 aria-label=核心架构>核心架构</a></li><li><a href=#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b aria-label=工作流程>工作流程</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e4%bc%98%e5%8a%bf aria-label=核心优势>核心优势</a></li><li><a href=#%e6%8f%92%e4%bb%b6%e7%94%9f%e6%80%81-1 aria-label=插件生态>插件生态</a></li><li><a href=#%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95%e8%87%aa%e5%ae%9a%e4%b9%89%e8%bd%ac%e6%8d%a2 aria-label=高级用法：自定义转换>高级用法：自定义转换</a></li><li><a href=#%e8%be%93%e5%87%ba%e6%a0%bc%e5%bc%8f%e5%a4%9a%e6%a0%b7%e6%80%a7 aria-label=输出格式多样性>输出格式多样性</a></li><li><a href=#%e4%b8%8e-markdown-it-%e7%9a%84%e5%af%b9%e6%af%94 aria-label="与 markdown-it 的对比">与 markdown-it 的对比</a></li><li><a href=#%e6%80%a7%e8%83%bd%e8%80%83%e9%87%8f aria-label=性能考量>性能考量</a></li><li><a href=#%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af-1 aria-label=实际应用场景>实际应用场景</a></li><li><a href=#%e5%9c%a8-sse-%e5%9c%ba%e6%99%af%e4%b8%8b%e7%9a%84%e5%ba%94%e7%94%a8 aria-label="在 SSE 场景下的应用">在 SSE 场景下的应用</a></li></ul></li></ul></li><li><a href=#%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8b%e6%9e%84%e5%bb%ba-ai-%e5%af%b9%e8%af%9d%e7%95%8c%e9%9d%a2 aria-label="实战案例：构建 AI 对话界面">实战案例：构建 AI 对话界面</a><ul><li><a href=#%e5%ae%8c%e6%95%b4%e6%9e%b6%e6%9e%84 aria-label=完整架构>完整架构</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93%e4%b8%8e%e5%b1%95%e6%9c%9b aria-label=总结与展望>总结与展望</a></li></ul></div></details></div></div></main><script type=text/javascript>function compute(){const t=document.getElementById("post-main"),e=document.getElementById("post-toc");if(t.getBoundingClientRect().top<=0){if(e.style.position==="fixed")return;e.style.position="fixed";const n=document.body.getBoundingClientRect().right,s=t.getBoundingClientRect().right-t.getBoundingClientRect().left;e.style.left=`${(n+s)/2+3}px`}else e.style.position="absolute",e.style.left="calc(100% + 3px)"}window.addEventListener("scroll",compute)</script><footer class=post-footer><nav class=paginav><a class=next href=https://tomorrowthief.github.io/posts/ai-deepresearch/><span class=title>下一页 »</span><br><span>DeepResearch</span></a></nav></footer><script src=https://utteranc.es/client.js repo=tomorrowthief/tomorrowthief.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://tomorrowthief.github.io/>钟灵毓秀</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/tomorrowthief/hugo-blog rel=noopener target=_blank>Hugo-blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");console.log(document.body.clientHeight),window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function s(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>